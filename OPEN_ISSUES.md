# SNN 隐神经元状态空间：待解决问题清单

> 配套文档: SNN_SELECTIVE_STATE_SPACE.md
> 创建日期: 2025-02
> 状态追踪: 逐一讨论，解决后回写主文档

---

## P0：根本性缺失（不解决无法实现）

### Issue #1：编码方式 — 输出的 spike 序列如何解释为有意义的值？

**澄清**：编码问题不在输入端，在输出端。

- **输入端无问题**：PLIF 接收实数输入，neuron_comparison.ipynb 已验证。$x_t \in \mathbb{R}^D$ 直接进入隐神经元状态空间。
- **输出端是核心问题**：PLIF 输出 0/1 spike 序列，如何将这些 spike 解读为有意义的数值？

**数据流**：
```
实数输入 x_t → 隐神经元状态空间(PLIF) → K步 0/1 spike输出 → 编码解读 → 实数值
```

**方案**：二进制编码 — 将 K 个时间步的 0/1 spike 序列解释为 K-bit 二进制数，还原为实数。

**已确认**：
1. **K（bit 精度）**：取决于模型/组件的精度要求，与编码方式本身无关。确定模型精度后 K 即确定。
2. **MSB-first（高位优先）**：首脉冲最重要，高位对应低时间步，天然契合。
3. **bit 顺序与积累动力学的关系**：MSB-first 下，早期 spike（高位）在隐神经元积累信息较少时产生，后期 spike（低位）在更多上下文积累后产生——细粒度调整受益于更充分的上下文，与 PLIF 的积累动力学自然对齐。训练时 MSB 的梯度权重指数级大于 LSB，引导网络优先学对高位。
4. **主文档修正**：$x_t$ 标注需统一为实数输入（已修正，见下）。

**状态**：已解决

---

### ~~Issue #2：输出 $y_t$ 格式矛盾~~ → 不成立，已关闭

$W_{out}$ 是 SNN 线性层，包含脉冲神经元，输出天然是 spike。$y_t \in \mathbb{R}^D$ 只是维度标注，{0,1}^D ⊂ R^D，公式和数据流图无矛盾。

---

### Issue #3：整体架构 / 流水线 → 初步拓扑已完成

**已解决的子问题**：
1. ✅ 上游：编码层（普通 SNN: Linear + PLIF）将实数输入转为 spike
2. ✅ 下游：解码层将 spike 转为实数输出（二进制解码/发放率）+ 任务头
3. ✅ 本模块是 SNN Block 的核心组件，Block 堆叠 L 层构成完整模型
4. ✅ 层间接口：全部 spike（{0,1}^D），每个 Block 内部维护私有 V 状态空间
5. ✅ 残差连接：spike_in → W_skip → 电流，在输出神经元前与主路径电流相加
6. ✅ 门控路径：W_gate · spike_in（并行无状态，对应 Mamba Gate 分支）
7. ✅ 全网 SNN 约束：所有 W 层为 SNN 突触（spike 输入），无标准 ANN 组件
8. ✅ 两种神经元分工：隐状态空间用特殊 PLIF（动态 β/α/V_th），其余用普通 PLIF（固定参数）
9. ✅ α 写入增益调制：独立于 β 的写入控制，解耦衰减与写入（Mamba 的 Δ 耦合了两者）
10. ✅ 时间步对齐：K 步流水线同步处理，含完整数学证明（隐状态跨 token 连续性、块间同步、块间无需编解码、多时间尺度动力学分析、与 Mamba Δ 的等价性映射）

**已回写至主文档第 5 节（完整网络架构，含 5.7 时间步对齐数学证明）**

**状态**：架构设计已完成，细节待实验验证

---

### Issue #4：训练方法 → IG-ZO 框架已设计

**大方向已确定**：零阶梯度优化，不反向传播。

原有梯度相关子问题全部消解：
- ~~surrogate gradient~~ → 不需要，不反向传播
- ~~循环计算图梯度回传~~ → 不需要
- ~~BPTT 截断~~ → 不需要
- ~~β 链式梯度消失/爆炸~~ → 不存在
- ~~SpikingJelly autograd 支持~~ → 不需要

**已设计：信息论引导的零阶优化（IG-ZO）**

核心思想：将 Q5.md 的信息论工具从"验证工具"转化为"训练信号"，把任务损失分解为六个设计目标的参数组级定向更新。

六个设计目标的诊断-处方体系：
1. ✅ **上下文选择性**：Var_ctx[β|same input] → $W^{(V)}$ 是否有效
2. ✅ **多时间尺度分化**：β 分布熵 + MI_retro 分组 → 时间尺度是否坍缩
3. ✅ **静默积累有效性**：I(V_silent; y_future) → 积累是否有价值
4. ✅ **发放信息效率**：η_fire + IB 最优压缩率 → V_th 调整方向
5. ✅ **衰减-写入解耦**：Corr(α, β) → 解耦是否被利用
6. ✅ **跨时间尺度协调**：I(ΔV_short; Δβ_long) → N×N 矩阵是否起作用

辅助工具：
- Fisher 信息加权扰动（零阶自然梯度）
- 混合时间 t_mix 驱动的多时间尺度学习率
- β 分布保护（防止时间尺度坍缩的硬约束）

**已回写至主文档第 8 节（训练方法）**

**状态**：初步框架已完成（当前方案，将在实验中迭代优化）

---

## P1：数学框架中的含糊点（影响正确性）

### ~~Issue #5：V[t-1] 经 soft reset 后的"完整上下文"声称~~ → 不成立，已关闭

Soft reset 是信息表达，不是信息销毁。V -= V_th 后 V 仍然是全部历史输入的确定性函数——与 RNN 的 h[t] 每步变化但仍携带历史完全类比。

主文档中的简化公式 $V[t-1] = \sum \beta^k \cdot I[t-1-k]$ 用于说明指数加权直觉，"V 携带完整历史上下文"的论述无误。

---

### Issue #6：$W_\beta^{(V)}$ 的维度和计算方式

**结论**：通道独立 + 跨通道共享 N×N 矩阵。

**排除过程**：

- **方案A（全连接）排除**：$W^{(V)}$ 为 (DN×DN)，D=128 N=8 时 ~1M 参数。零阶梯度估计方差与参数维度成正比，不可能收敛。
- **方案C（纯对角）排除**：每个神经元只看自己的 V，切断了同通道内短程/长程神经元的协调通道。多时间尺度设计失去协同效果，退化为 N 个互不相干的自适应 LIF。

**选择方案B（通道独立）的理由**：

1. **通道间独立的合理性**：不同通道 d 代表不同特征维度，通道 d=3 的膜电位积累量对通道 d=100 的衰减率没有直接因果关系。Mamba 的对角 A 做了相同假设，实践中已验证有效。
2. **通道内交互的必要性**：同通道的 N 个神经元是同一信息维度在不同时间尺度的观测窗口。短程神经元膜电位升高 → 长程神经元需要知道（调整 V_th 接纳新信息）；长程膜电位持续高 → 短程可以放心加速遗忘（长程已在保管）。纯对角切断了这条协作通路。
3. **比 Mamba 多的一步**：Mamba 的对角 A 使同通道 N 个状态也互相独立。我们的 N×N 矩阵让不同时间尺度之间有反馈，这是 Mamba 未利用的结构。

**进一步优化：共享 N×N**

所有 D 个通道共享同一个 N×N 矩阵。理由：短程/长程之间的交互模式（"最近有重要输入 → 长程准备接收"）是跨通道通用的，与具体特征维度无关。

参数量：$W_\beta^{(V)}$ = N² = 64（N=8），$W_\alpha^{(V)}$ = 64，$W_{th}^{(V)}$ = 64，总计 **192 个参数**。

起步用共享版本，实验发现通道间需要差异化时再升级为每通道独立的 N×N（8K 参数）。

**状态**：已解决

---

### Issue #7：PLIF 基底神经元选型写入文档

已回写至主文档：
1. 3.1 节新增基底选型说明及理由（结构匹配、实数输入/spike输出、简单基底+外部复杂性）
2. 数据流图已更新为"D×N 个PLIF神经元"
3. 其余"LIF"提及均为对比对象（"普通LIF层"），保持不变

**状态**：已解决

---

## P2：待定设计选择 + 未提及的问题

### Issue #8：五个原有开放问题（Q1-Q5）

| 编号 | 问题 | 状态 |
|------|------|------|
| Q1 | 输出用 spike 还是膜电位加权？ | **已解决** — spike 输出，二进制编码解读 |
| Q2 | W_in / W_out 有无时间状态？ | **归入 Issue #3** — 属于整体架构设计问题 |
| Q3 | N 取多少？ | **已关闭** — 实验超参数，非设计阶段问题 |
| Q4 | 调制网络复杂度？ | **已解决** — $W^{(V)}$ 通道独立+共享 N×N（Issue #6） |
| Q5 | 如何验证静默积累？ | **已解决** — 完整方法论见 Q5.md |

**状态**：全部已解决或归入其他 Issue

---

### ~~Issue #9：归一化机制~~ → 不成立，已关闭

膜电位有两个天然调节机制：β < 1 的持续衰减 + soft reset 的阈值削减。无需人为归一化，归一化反而破坏 V 的绝对值语义和 voltage-gated 调制机制。

---

### ~~Issue #10：序列边界处理 + 具体任务定义~~ → 不成立，已关闭

序列内 V 不重置（这就是上下文积累），序列结束时重置 V 开始新序列。不需要讨论。任务定义属于实验层面细节。

---

## 讨论记录

> 以下按讨论顺序记录每个 Issue 的讨论过程和结论。解决后将结论回写到主文档。

（待填充）
